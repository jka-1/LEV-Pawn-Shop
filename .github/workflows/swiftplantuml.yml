name: Generate Swift UML (SwiftPlantUML)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  swiftplantuml:
    runs-on: macos-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true
          echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $GITHUB_ENV
          echo 'eval "$(/usr/local/bin/brew shellenv)"' >> $GITHUB_ENV
          eval "$(/opt/homebrew/bin/brew shellenv || true)"
          eval "$(/usr/local/bin/brew shellenv || true)"

      - name: Install SwiftPlantUML
        run: |
          brew tap marcoeidinger/plantuml || true
          brew install swiftplantuml || (brew update && brew install swiftplantuml)

      - name: Install PlantUML (jar) and Java
        run: |
          brew install --cask temurin || true
          curl -L -o plantuml.jar https://downloads.sourceforge.net/project/plantuml/plantuml.jar || true

      - name: Generate PlantUML script (.puml)
        run: |
          swiftplantuml classdiagram ./ --output consoleOnly > diagram.puml

      - name: Render diagram to PNG
        run: |
          java -jar plantuml.jar -tpng diagram.puml -o output || true
          ls -la output || true

      - name: Upload artifacts (puml & images)
        uses: actions/upload-artifact@v4
        with:
          name: swiftplantuml-diagrams
          path: |
            diagram.puml
            output/*.png
            output/*.svg
