name: Generate Swift UML (SwiftPlantUML)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  swiftplantuml:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Homebrew
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true

          if [ -d "/opt/homebrew/bin" ]; then
            echo "HOMEBREW_PREFIX=/opt/homebrew" >> $GITHUB_ENV
          elif [ -d "/usr/local/bin" ]; then
            echo "HOMEBREW_PREFIX=/usr/local" >> $GITHUB_ENV
          fi
          
          echo "$HOMEBREW_PREFIX/bin" >> $GITHUB_PATH

      - name: Install SwiftPlantUML
        run: |
          brew tap marcoeidinger/plantuml || true
          brew update
          brew install swiftplantuml

      - name: Install Java + PlantUML
        run: |
          brew install --cask temurin || true
          curl -L -o plantuml.jar https://downloads.sourceforge.net/project/plantuml/plantuml.jar

      - name: Generate PlantUML script (.puml)
        run: |
          swiftplantuml classdiagram ./ --output consoleOnly > diagram.puml

      - name: Render diagram to PNG
        run: |
          java -jar plantuml.jar -tpng diagram.puml -o output
          ls -la output

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: swiftplantuml-diagrams
          path: |
            diagram.puml
            output/*.png
            output/*.svg
